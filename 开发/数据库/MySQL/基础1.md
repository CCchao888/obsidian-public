

# äº‹åŠ¡



## äº‹åŠ¡æœºåˆ¶


### 1ï¸âƒ£ åŒä¸€é¡µçš„æ•°æ®æ˜¯ä¸æ˜¯è¿žç»­å­˜å‚¨çš„ï¼Ÿ

- **åœ¨åŒä¸€é¡µ (page, 16KB)** å†…ï¼Œæ•°æ®æ˜¯ **ç‰©ç†ä¸Šç´§æŒ¨ç€å­˜æ”¾** çš„ï¼ˆå°±åƒä¸€ä¸ªå°æ•°ç»„ä¸€æ ·ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸ºå®ƒæ˜¯â€œè¿žç»­å­˜å‚¨â€ã€‚
    
- **é¡µä¹‹é—´** æ˜¯é€šè¿‡æŒ‡é’ˆè¿žæŽ¥çš„ï¼Œä¸ä¿è¯ç‰©ç†è¿žç»­ã€‚
    
- **é¡µå†…é¡ºåº**ï¼š
    
    - InnoDB çš„è¡¨æ•°æ®æŒ‰ç…§ **ä¸»é”®é¡ºåº** ç»„ç»‡ï¼ˆèšç°‡ç´¢å¼•ï¼‰ã€‚
        
    - é¡µå†…çš„æ•°æ®é¡¹æ˜¯ **æŒ‰ä¸»é”®é€’å¢žæŽ’åº** çš„ã€‚
        
    - å¦‚æžœæ’å…¥ä¸€ä¸ªæ–°ä¸»é”®å€¼åœ¨ä¸­é—´ä½ç½®ï¼Œå¯èƒ½ä¼šè§¦å‘ **é¡µåˆ†è£‚**ï¼ˆæŠŠä¸€ä¸ªé¡µæ‹†æˆä¸¤ä¸ªï¼‰ã€‚
        

ðŸ‘‰ æ‰€ä»¥ï¼ŒInnoDB çš„è¡¨æ•°æ®å°±æ˜¯ä¸€æ£µ **B+ æ ‘**ï¼Œå¶å­èŠ‚ç‚¹é¡µä¹‹é—´æ˜¯ **æœ‰åºé“¾è¡¨**ï¼Œè€Œæ¯ä¸ªé¡µé‡Œçš„è¡Œè®°å½•ä¹ŸæŒ‰ä¸»é”®æŽ’å¥½åºã€‚

---

### 2ï¸âƒ£ InnoDB é»˜è®¤äº‹åŠ¡æœºåˆ¶

#### 2.1 autocommit æ¨¡å¼

- InnoDB é»˜è®¤å¼€å¯ **äº‹åŠ¡æ”¯æŒ**ï¼Œå¹¶ä¸” **autocommit = ON**ã€‚
    
- è¿™æ„å‘³ç€ï¼š
    
    - ä½ éšä¾¿æ‰§è¡Œä¸€æ¡ SQLï¼ˆ`INSERT/UPDATE/DELETE`ï¼‰ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ã€‚
        
    - SQL æ‰§è¡Œå®ŒæˆåŽï¼ŒInnoDB ä¼šç«‹åˆ» `COMMIT`ã€‚
        

**ä¾‹å­**ï¼š

```sql
UPDATE user SET balance = balance - 100 WHERE id = 1;
```

- InnoDB èƒŒåŽä¼šè‡ªåŠ¨ï¼š
    
    1. å¼€å¯ä¸€ä¸ªäº‹åŠ¡
        
    2. æ‰§è¡Œæ›´æ–°
        
    3. å†™ undo log + redo log
        
    4. è‡ªåŠ¨æäº¤äº‹åŠ¡
        

æ‰€ä»¥ä½ è™½ç„¶æ²¡å†™ `BEGIN`ï¼Œä½†å®ƒç¡®å®žæ˜¯ä¸€ä¸ªäº‹åŠ¡ã€‚

---

#### 2.2 æ‰‹åŠ¨å¼€å¯äº‹åŠ¡çš„åœºæ™¯

- å¦‚æžœä½ è¦ä¿è¯ **å¤šæ¡ SQL çš„åŽŸå­æ€§**ï¼Œå¿…é¡»æ‰‹åŠ¨æŽ§åˆ¶äº‹åŠ¡ï¼š
    
    ```sql
    BEGIN;
    UPDATE account SET balance = balance - 100 WHERE id = 1;
    UPDATE account SET balance = balance + 100 WHERE id = 2;
    COMMIT;
    ```
    
    å¦‚æžœç¬¬äºŒæ¡å¤±è´¥ï¼Œä½ å¯ä»¥ `ROLLBACK;`ï¼Œä¿è¯æ•°æ®ä¸€è‡´ã€‚
    

---

### 3ï¸âƒ£ autocommit å¸¦æ¥çš„é—®é¢˜

- **é—®é¢˜ 1ï¼šå¤šè¯­å¥é€»è¾‘æ— æ³•ä¿è¯åŽŸå­æ€§**
    
    - é»˜è®¤ autocommit ä¸‹ï¼Œæ¯æ¡ SQL éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ã€‚
        
    - å¦‚æžœä½ è¦â€œè½¬è´¦â€è¿™ç§åœºæ™¯ï¼ˆA æ‰£é’±ã€B åŠ é’±ï¼‰ï¼Œä½†åªæ‰§è¡Œäº†ç¬¬ä¸€æ¡ï¼Œäº‹åŠ¡å°±å·²ç»æäº¤äº† â†’ æ•°æ®ä¸ä¸€è‡´ã€‚
        
- **é—®é¢˜ 2ï¼šæ€§èƒ½é—®é¢˜**
    
    - äº‹åŠ¡æäº¤æ¶‰åŠæ—¥å¿—å†™å…¥ (redo log + binlog)ã€‚
        
    - å¦‚æžœæ¯æ¡ SQL éƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œæ—¥å¿—åˆ·ç›˜é¢‘ç¹ï¼Œæ€§èƒ½ä¼šä¸‹é™ã€‚
        
    - é€šå¸¸åœ¨æ‰¹é‡æ“ä½œæ—¶ä¼šå…³é—­ autocommitï¼Œæ‰‹åŠ¨æŽ§åˆ¶äº‹åŠ¡ã€‚
        
- **é—®é¢˜ 3ï¼šé”ç²’åº¦ä¸ŽæŒæœ‰æ—¶é—´**
    
    - åœ¨ autocommit ä¸‹ï¼ŒSQL ç»“æŸé©¬ä¸Šé‡Šæ”¾é”ï¼Œåˆ«çš„äº‹åŠ¡å¯ä»¥ç«‹åˆ»è¿›æ¥ã€‚
        
    - åœ¨æ‰‹åŠ¨äº‹åŠ¡ä¸‹ï¼Œé”ä¼šä¿æŒåˆ° `COMMIT/ROLLBACK`ï¼Œéš”ç¦»æ€§æ›´å¼ºã€‚
        

---

âœ… **æ€»ç»“**ï¼š

- **é¡µå†…æ•°æ®æ˜¯æŒ‰ä¸»é”®é¡ºåºå­˜å‚¨çš„**ï¼Œè¿žç»­ä¸”æœ‰åºã€‚
    
- **InnoDB é»˜è®¤æœ‰äº‹åŠ¡æ”¯æŒ**ï¼Œå¹¶ä¸” autocommit æ‰“å¼€ â†’ æ¯æ¡ SQL å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡ã€‚
    
- **åªæœ‰æ¶‰åŠå¤šæ¡è¯­å¥çš„ä¸šåŠ¡é€»è¾‘**ï¼Œæ‰éœ€è¦æ‰‹åŠ¨å¼€å¯äº‹åŠ¡ã€‚
    
- **autocommit æœ‰å®‰å…¨æ€§ä¸Žæ€§èƒ½ä¸Šçš„å±€é™**ï¼Œå®žé™…é¡¹ç›®é‡Œç»å¸¸ä¼šæ‰‹åŠ¨ç®¡ç†äº‹åŠ¡ã€‚


## ä»£ç å®žæ“


### 1ï¸âƒ£ Java & Spring Boot äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒæœºåˆ¶

Spring Boot ä½¿ç”¨ **Spring Transaction Management** æ¥ç®¡ç†äº‹åŠ¡ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡ **AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰+ æ•°æ®åº“é©±åŠ¨çš„äº‹åŠ¡ API** å®žçŽ°çš„ã€‚  
æœ€å¸¸è§çš„å°±æ˜¯ `@Transactional` æ³¨è§£ã€‚

### `@Transactional` æ³¨è§£çš„ä½œç”¨

- æ”¾åœ¨ **æ–¹æ³•** æˆ– **ç±»** ä¸Šï¼Œç”¨æ¥å£°æ˜Žè¿™ä¸ªèŒƒå›´å†…çš„æ•°æ®åº“æ“ä½œè¦åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œå®Œæˆã€‚
    
- Spring ä¼šè‡ªåŠ¨å¸®ä½ ï¼š
    
    1. **å¼€å¯äº‹åŠ¡**
        
    2. æ‰§è¡Œæ–¹æ³•é‡Œçš„ SQLï¼ˆé€šè¿‡ MyBatis/JPA/JDBCï¼‰
        
    3. å¦‚æžœæ²¡æœ‰å¼‚å¸¸ â†’ `COMMIT`
        
    4. å¦‚æžœæœ‰å¼‚å¸¸ â†’ `ROLLBACK`
        

**ç¤ºä¾‹**ï¼š

```java
@Service
public class AccountService {
    @Autowired
    private AccountMapper accountMapper;

    @Transactional  // å¼€å¯äº‹åŠ¡
    public void transferMoney(Long fromId, Long toId, int amount) {
        accountMapper.decreaseBalance(fromId, amount); // æ‰£é’±
        accountMapper.increaseBalance(toId, amount);   // åŠ é’±
    }
}
```

- å¦‚æžœ `decreaseBalance` æˆåŠŸï¼Œ`increaseBalance` å¤±è´¥ï¼ˆæ¯”å¦‚ SQL å¼‚å¸¸ï¼‰ï¼ŒSpring ä¼šè‡ªåŠ¨å›žæ»šäº‹åŠ¡ â†’ ä¿è¯è½¬è´¦åŽŸå­æ€§ã€‚
    

---

### 2ï¸âƒ£ ä½¿ç”¨äº‹åŠ¡çš„æœ€ä½³å®žè·µ

## (1) ä»€ä¹ˆæƒ…å†µè¦ç”¨äº‹åŠ¡ï¼Ÿ

- **å¤šè¡¨å†™æ“ä½œ**ï¼šæ¯”å¦‚è®¢å•ç³»ç»Ÿï¼Œè¦åŒæ—¶æ’å…¥è®¢å•è¡¨ã€æ›´æ–°åº“å­˜è¡¨ã€ä¿®æ”¹è´¦æˆ·ä½™é¢ã€‚
    
- **ä¸€ç»„å¿…é¡»åŽŸå­æ€§æ‰§è¡Œçš„æ“ä½œ**ï¼šæ¯”å¦‚è½¬è´¦ã€æ‰¹é‡å†™å…¥ã€‚
    
- **å¹‚ç­‰æ€§å·®çš„æ“ä½œ**ï¼šå®¹æ˜“é€ æˆè„æ•°æ®ï¼Œéœ€è¦å›žæ»šä¿éšœã€‚
    

## (2) ä»€ä¹ˆæƒ…å†µä¸è¦æ»¥ç”¨äº‹åŠ¡ï¼Ÿ

- **åªè¯»æŸ¥è¯¢**ï¼šå¤§éƒ¨åˆ† `SELECT` ä¸éœ€è¦äº‹åŠ¡ã€‚å¯ä»¥ç”¨ `@Transactional(readOnly=true)` ä¼˜åŒ–ï¼ˆSpring ä¼šè·³è¿‡éƒ¨åˆ†å¼€é”€ï¼‰ã€‚
    
- **å¤§æ‰¹é‡æ“ä½œ**ï¼šäº‹åŠ¡æ—¶é—´è¿‡é•¿ä¼šå¯¼è‡´é”ç«žäº‰ï¼Œå»ºè®®åˆ†æ‰¹æäº¤ã€‚
    

---

### 3ï¸âƒ£ `@Transactional` çš„å…³é”®å‚æ•°

```java
@Transactional(
    propagation = Propagation.REQUIRED,   // äº‹åŠ¡ä¼ æ’­è¡Œä¸º
    isolation = Isolation.REPEATABLE_READ, // äº‹åŠ¡éš”ç¦»çº§åˆ«
    timeout = 30,  // è¶…æ—¶æ—¶é—´
    rollbackFor = Exception.class, // å“ªäº›å¼‚å¸¸è§¦å‘å›žæ»š
    readOnly = false // æ˜¯å¦åªè¯»
)
```

### è§£é‡Šå‡ ä¸ªæ ¸å¿ƒï¼š

- **propagationï¼ˆä¼ æ’­è¡Œä¸ºï¼‰**
    
    - `REQUIRED`ï¼ˆé»˜è®¤ï¼‰ï¼šå¦‚æžœå½“å‰æœ‰äº‹åŠ¡ï¼Œå°±åŠ å…¥äº‹åŠ¡ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ªäº‹åŠ¡ã€‚
        
    - `REQUIRES_NEW`ï¼šä¸ç®¡æœ‰æ²¡æœ‰äº‹åŠ¡ï¼Œéƒ½æ–°å»ºäº‹åŠ¡ï¼ˆåŽŸæ¥çš„æŒ‚èµ·ï¼‰ã€‚
        
    - `NESTED`ï¼šåµŒå¥—äº‹åŠ¡ï¼Œéƒ¨åˆ†å¤±è´¥å¯ä»¥å•ç‹¬å›žæ»šã€‚
        
- **isolationï¼ˆéš”ç¦»çº§åˆ«ï¼‰**  
    å¯¹åº” MySQL çš„éš”ç¦»çº§åˆ«ï¼ˆ`READ_COMMITTED`ã€`REPEATABLE_READ` ç­‰ï¼‰ã€‚
    
    - Spring é»˜è®¤ï¼š`DEFAULT` â†’ ä½¿ç”¨æ•°æ®åº“é»˜è®¤ï¼ˆMySQL InnoDB é»˜è®¤æ˜¯ `REPEATABLE READ`ï¼‰ã€‚
        
- **rollbackFor**
    
    - Spring é»˜è®¤åªåœ¨ **è¿è¡Œæ—¶å¼‚å¸¸ (RuntimeException)** å›žæ»šã€‚
        
    - å¦‚æžœä½ æƒ³é‡åˆ°æ‰€æœ‰å¼‚å¸¸éƒ½å›žæ»šï¼Œè¦å†™ï¼š
        
        ```java
        @Transactional(rollbackFor = Exception.class)
        ```
        

---

### 4ï¸âƒ£ Spring Boot å†™ MySQL ä»£ç çš„å»ºè®®

âœ… **å»ºè®® 1ï¼šä¸€ä¸ªä¸šåŠ¡æ–¹æ³• = ä¸€ä¸ªäº‹åŠ¡**

- æŠŠé€»è¾‘æ‹†åˆ†åˆ° service å±‚ï¼ŒDAO å±‚åªè´Ÿè´£å•è¡¨æ“ä½œã€‚
    
- åœ¨ service æ–¹æ³•ä¸ŠåŠ  `@Transactional`ã€‚
    

âœ… **å»ºè®® 2ï¼šé¿å…äº‹åŠ¡é‡Œå†™å¤ªå¤š SQL**

- å¤§äº‹åŠ¡å®¹æ˜“é”è¡¨/é”è¡Œï¼Œå»ºè®®æ‹†å°äº‹åŠ¡æˆ–æ‰¹å¤„ç†ã€‚
    

âœ… **å»ºè®® 3ï¼šè¯»å†™åˆ†ç¦»**

- æŸ¥è¯¢èµ°ä»Žåº“ï¼ˆä¸ç”¨äº‹åŠ¡æˆ–åªè¯»äº‹åŠ¡ï¼‰ã€‚
    
- å†™æ“ä½œèµ°ä¸»åº“ï¼ˆäº‹åŠ¡ä¿è¯ä¸€è‡´æ€§ï¼‰ã€‚
    

âœ… **å»ºè®® 4ï¼šå–„ç”¨ `rollbackFor`**

- ä¸è¦åªä¾èµ–é»˜è®¤çš„ RuntimeException å›žæ»šï¼Œå¾ˆå¤š Checked å¼‚å¸¸ï¼ˆæ¯”å¦‚ `SQLException`ï¼‰ä¹Ÿè¦å›žæ»šã€‚
    

âœ… **å»ºè®® 5ï¼šæ—¥å¿— + å¼‚å¸¸æ•èŽ·**

- åœ¨äº‹åŠ¡æ–¹æ³•é‡Œè¦è®°å½•å…³é”®æ—¥å¿—ï¼Œæ–¹ä¾¿æŽ’æŸ¥äº‹åŠ¡å›žæ»šåŽŸå› ã€‚
    

---

### 5ï¸âƒ£ ç¤ºä¾‹ä»£ç 

```java
@Service
public class OrderService {
    @Autowired
    private OrderMapper orderMapper;
    @Autowired
    private InventoryMapper inventoryMapper;

    @Transactional(rollbackFor = Exception.class)
    public void createOrder(Long userId, Long productId, int quantity) {
        // 1. åˆ›å»ºè®¢å•
        orderMapper.insertOrder(userId, productId, quantity);

        // 2. æ‰£å‡åº“å­˜
        inventoryMapper.decreaseStock(productId, quantity);

        // 3. æ¨¡æ‹Ÿå¼‚å¸¸ï¼ˆæ¯”å¦‚åº“å­˜ä¸è¶³ï¼‰
        if (quantity > 100) {
            throw new RuntimeException("ä¸‹å•å¤±è´¥ï¼Œæ•°é‡è¿‡å¤§ï¼");
        }

        // å¦‚æžœå¼‚å¸¸ â†’ æ•´ä¸ªäº‹åŠ¡å›žæ»šï¼ˆè®¢å•ã€åº“å­˜æ“ä½œéƒ½ä¸æ‰§è¡Œï¼‰
    }
}
```

---

### âœ… æ€»ç»“

- `@Transactional` æ˜¯ Spring Boot æ“ä½œäº‹åŠ¡çš„æ ¸å¿ƒæ³¨è§£ã€‚
    
- è‡ªåŠ¨å¸®ä½  **å¼€å¯ã€æäº¤ã€å›žæ»šäº‹åŠ¡**ã€‚
    
- ç”¨äºŽ **å¤šè¡¨æ“ä½œã€å†™æ“ä½œ**ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ã€‚
    
- éœ€è¦æ³¨æ„ **ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€å›žæ»šç­–ç•¥**ã€‚
    
- å†™ MySQL ä»£ç æ—¶å»ºè®® **service å±‚è´Ÿè´£äº‹åŠ¡ï¼ŒDAO å±‚åªè´Ÿè´£ SQL**ã€‚
    



# é”


### æ ¸å¿ƒæ¦‚å¿µä¸Žæ¯”å–»

æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æŠŠæ•°æ®åº“çš„ä¸€å¼ è¡¨çœ‹ä½œæ˜¯ä¸€æœ¬**ç”µè¯ç°¿**ï¼Œé‡Œé¢çš„æ¯ä¸€è¡Œè®°å½•å°±æ˜¯ä¸€æ¡**ç”µè¯å·ç è®°å½•**ã€‚

-   **è¡Œé” (Record Lock)**ï¼šé”ä½ç”µè¯ç°¿é‡Œ**ä¸€æ¡å…·ä½“çš„è®°å½•**ã€‚æ¯”å¦‚ï¼Œé”ä½â€œå¼ ä¸‰â€çš„é‚£ä¸€è¡Œï¼Œåˆ«äººå°±ä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤å¼ ä¸‰çš„ä¿¡æ¯ã€‚
-   **é—´éš™é” (Gap Lock)**ï¼šé”ä½ç”µè¯ç°¿é‡Œ**ä¸¤ä¸ªç›¸é‚»è®°å½•ä¹‹é—´çš„â€œé—´éš™â€**ã€‚æ¯”å¦‚ï¼Œé”ä½â€œæŽå››â€ï¼ˆç¬¬10æ¡ï¼‰å’Œâ€œçŽ‹äº”â€ï¼ˆç¬¬11æ¡ï¼‰ä¹‹é—´çš„ç©ºç™½ä½ç½®ï¼Œé˜²æ­¢ä»»ä½•äººåœ¨è¿™ä¸ªç©ºéš™é‡Œæ’å…¥ä¸€æ¡æ–°çš„è®°å½•ã€‚
-   **ä¸´é”®é” (Next-Key Lock)**ï¼šå®ƒæ˜¯ **è¡Œé” + é—´éš™é”** çš„ç»„åˆã€‚å®ƒé”ä½ä¸€æ¡è®°å½•**ä»¥åŠè¯¥è®°å½•ä¹‹å‰çš„é—´éš™**ã€‚æ¯”å¦‚ï¼Œé”ä½â€œçŽ‹äº”â€ï¼ˆç¬¬11æ¡ï¼‰è¿™æ¡è®°å½•**ä»¥åŠ**â€œæŽå››â€å’Œâ€œçŽ‹äº”â€ä¹‹é—´çš„é—´éš™ã€‚è¿™æ˜¯MySQLé»˜è®¤çš„é”æ¨¡å¼ã€‚

---

### è¯¦ç»†è§£é‡Š

#### 1. è¡Œé” (Record Lock)

-   **æ˜¯ä»€ä¹ˆ**ï¼šé”ä½**ç´¢å¼•é¡¹**å¯¹åº”çš„å…·ä½“ä¸€è¡Œæ•°æ®ã€‚
-   **ç›®çš„**ï¼šé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹**å·²å­˜åœ¨çš„è¿™ä¸€è¡Œ**è¿›è¡Œ`UPDATE`æˆ–`DELETE`æ“ä½œï¼Œä¿è¯æ•°æ®åœ¨äº‹åŠ¡æœŸé—´çš„ä¸€è‡´æ€§ã€‚
-   **è§¦å‘æ¡ä»¶**ï¼šåœ¨`READ COMMITTED`å’Œ`REPEATABLE READ`éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¯¹ä½¿ç”¨**å”¯ä¸€ç´¢å¼•**ï¼ˆå¦‚ä¸»é”®ï¼‰è¿›è¡Œ**ç²¾ç¡®åŒ¹é…**ï¼ˆå¦‚ `WHERE id = 5`ï¼‰çš„æŸ¥è¯¢è¿›è¡ŒåŠ é”æ—¶ï¼Œä¼šä½¿ç”¨è¡Œé”ã€‚
-   **ä¾‹å­**ï¼š
    ```sql
    -- äº‹åŠ¡A
    BEGIN;
    SELECT * FROM users WHERE id = 10 FOR UPDATE; -- å¯¹id=10è¿™ä¸€è¡ŒåŠ è¡Œé”ï¼ˆå†™é”ï¼‰

    -- äº‹åŠ¡B
    UPDATE users SET name = 'foo' WHERE id = 10; -- ä¼šè¢«é˜»å¡žï¼Œç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾é”
    UPDATE users SET name = 'bar' WHERE id = 11; -- å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œä¸å—å½±å“
    ```

#### 2. é—´éš™é” (Gap Lock)

-   **æ˜¯ä»€ä¹ˆ**ï¼šé”ä½ç´¢å¼•é¡¹ä¹‹é—´çš„**èŒƒå›´**ï¼Œä½†ä¸åŒ…æ‹¬ç´¢å¼•é¡¹æœ¬èº«ã€‚å®ƒé”çš„æ˜¯ä¸€ä¸ªâ€œå¼€åŒºé—´â€ï¼Œä¾‹å¦‚ `(5, 10)`ã€‚
-   **ç›®çš„**ï¼š**é˜²æ­¢å¹»è¯»ï¼ˆPhantom Readï¼‰**ã€‚é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨é”å®šçš„é—´éš™ä¸­**æ’å…¥**æ–°çš„æ•°æ®ï¼Œä»Žè€Œä¿è¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æ‰§è¡Œç›¸åŒçš„æŸ¥è¯¢ï¼Œçœ‹åˆ°çš„ç»“æžœé›†æ˜¯ä¸€è‡´çš„ã€‚
-   **è§¦å‘æ¡ä»¶**ï¼šä»…åœ¨ `REPEATABLE READ`ï¼ˆMySQLé»˜è®¤éš”ç¦»çº§åˆ«ï¼‰åŠä»¥ä¸Šéš”ç¦»çº§åˆ«ç”Ÿæ•ˆã€‚é€šå¸¸åœ¨**èŒƒå›´æŸ¥è¯¢**æˆ–**æŸ¥è¯¢ä¸å­˜åœ¨çš„è®°å½•**æ—¶ä½¿ç”¨**éžå”¯ä¸€ç´¢å¼•**ï¼ˆæˆ–æ²¡èµ°ç´¢å¼•ï¼‰æ—¶è§¦å‘ã€‚
-   **ä¾‹å­**ï¼š
    å‡è®¾è¡¨ä¸­æœ‰`id`ä¸º 5, 10, 15 çš„è®°å½•ã€‚
    ```sql
    -- äº‹åŠ¡A
    BEGIN;
    SELECT * FROM users WHERE id BETWEEN 10 AND 15 FOR UPDATE;
    -- ä¸ä»…é”ä½äº†id=10å’Œ15çš„çŽ°æœ‰è¡Œï¼Œè¿˜ä¼šé”ä½(5,10), (10,15), (15, +âˆž) è¿™äº›é—´éš™ã€‚

    -- äº‹åŠ¡B
    INSERT INTO users (id, name) VALUES (12, 'new'); -- è¯•å›¾åœ¨(10,15)çš„é—´éš™æ’å…¥ï¼Œä¼šè¢«é˜»å¡žï¼
    INSERT INTO users (id, name) VALUES (20, 'new'); -- è¯•å›¾åœ¨(15, +âˆž)çš„é—´éš™æ’å…¥ï¼Œä¹Ÿä¼šè¢«é˜»å¡žï¼
    INSERT INTO users (id, name) VALUES (3, 'new');  -- åœ¨(è´Ÿæ— ç©·,5)çš„é—´éš™æ’å…¥ï¼Œå¯ä»¥æˆåŠŸï¼ˆå¦‚æžœè¿™ä¸ªé—´éš™æ²¡è¢«é”ï¼‰
    ```

#### 3. ä¸´é”®é” (Next-Key Lock)

-   **æ˜¯ä»€ä¹ˆ**ï¼š**è¡Œé” + é—´éš™é”** çš„ç»„åˆã€‚å®ƒé”ä½ä¸€æ¡è®°å½•ä»¥åŠè¯¥è®°å½•ä¹‹å‰çš„é—´éš™ã€‚å®ƒæ˜¯ä¸€ä¸ªâ€œå·¦å¼€å³é—­â€çš„åŒºé—´ï¼Œä¾‹å¦‚ `(5, 10]`ã€‚
-   **ç›®çš„**ï¼šåŒæ ·æ˜¯**é˜²æ­¢å¹»è¯»**ã€‚å®ƒæ˜¯MySQLåœ¨ `REPEATABLE READ` éš”ç¦»çº§åˆ«ä¸‹**é»˜è®¤çš„åŠ é”ç®—æ³•**ã€‚
-   **å¦‚ä½•å·¥ä½œ**ï¼šå½“MySQLæ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œå®ƒä¼šä¸ºæ‰«æåˆ°çš„æ¯ä¸€ä¸ªç´¢å¼•é¡¹åŠ ä¸Šä¸´é”®é”ã€‚è¿™æ ·æ—¢é”ä½äº†å·²ç»å­˜åœ¨çš„è®°å½•ï¼ˆé˜²æ­¢ä¿®æ”¹ï¼‰ï¼Œä¹Ÿé”ä½äº†è®°å½•ä¹‹é—´çš„é—´éš™ï¼ˆé˜²æ­¢æ’å…¥ï¼‰ã€‚
-   **ä¾‹å­**ï¼š
    åŒæ ·å‡è®¾æœ‰`id`ä¸º 5, 10, 15 çš„è®°å½•ã€‚
    ```sql
    -- äº‹åŠ¡A
    SELECT * FROM users WHERE id > 9 AND id < 16 FOR UPDATE;

    -- MySQLå¯èƒ½ä¼šåŠ ä»¥ä¸‹ä¸´é”®é”ï¼š
    -- (5, 10] -- é”ä½10è¿™æ¡è®°å½•å’Œå®ƒä¹‹å‰çš„é—´éš™
    -- (10, 15] -- é”ä½15è¿™æ¡è®°å½•å’Œå®ƒä¹‹å‰çš„é—´éš™
    -- (15, +âˆž) -- é”ä½15ä¹‹åŽçš„æ­£æ— ç©·é—´éš™ï¼ˆè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é—´éš™é”ï¼‰

    -- å› æ­¤ï¼Œä»»ä½•è¯•å›¾æ’å…¥id=6, id=11, id=16çš„æ“ä½œéƒ½ä¼šè¢«é˜»å¡žã€‚
    -- ä»»ä½•è¯•å›¾ä¿®æ”¹æˆ–åˆ é™¤id=10æˆ–id=15çš„æ“ä½œä¹Ÿä¼šè¢«é˜»å¡žã€‚
    ```

### å…³ç³»ä¸ŽåŒºåˆ«æ€»ç»“

| é”ç±»åž‹ | é”å®šèŒƒå›´ | ä¸»è¦ç›®çš„ | ç”Ÿæ•ˆçš„éš”ç¦»çº§åˆ« | æ¯”å–» |
| :--- | :--- | :--- | :--- | :--- |
| **è¡Œé” (Record Lock)** | **å…·ä½“çš„æŸä¸€è¡Œ** | é˜²æ­¢å·²å­˜åœ¨çš„è®°å½•è¢«ä¿®æ”¹æˆ–åˆ é™¤ | `READ COMMITTED`, `REPEATABLE READ` | é”ä½ç”µè¯ç°¿é‡Œâ€œå¼ ä¸‰â€è¿™ä¸€è¡Œ |
| **é—´éš™é” (Gap Lock)** | **è¡Œä¸Žè¡Œä¹‹é—´çš„é—´éš™** | **é˜²æ­¢æ’å…¥**æ–°æ•°æ®ï¼Œè§£å†³å¹»è¯» | `REPEATABLE READ` åŠä»¥ä¸Š | é”ä½â€œæŽå››â€å’Œâ€œçŽ‹äº”â€ä¹‹é—´çš„ç©ºç™½ï¼Œä¸è®©å†™æ–°åå­— |
| **ä¸´é”®é” (Next-Key Lock)** | **è¡Œ + è¯¥è¡Œä¹‹å‰çš„é—´éš™** | **é˜²æ­¢æ’å…¥å’Œä¿®æ”¹**ï¼Œè§£å†³å¹»è¯» | `REPEATABLE READ`ï¼ˆé»˜è®¤ç®—æ³•ï¼‰ | é”ä½â€œçŽ‹äº”â€è¿™è¡Œ**ä»¥åŠ**â€œæŽå››â€å’Œâ€œçŽ‹äº”â€ä¹‹é—´çš„ç©ºç™½ |

**å…³ç³»**ï¼š
-   ä¸´é”®é” = è¡Œé” + é—´éš™é”
-   é—´éš™é”æ˜¯ä¸´é”®é”çš„ä¸€éƒ¨åˆ†ã€‚
-   åœ¨**å”¯ä¸€ç´¢å¼•**çš„**ç­‰å€¼æŸ¥è¯¢**æ—¶ï¼Œä¸´é”®é”ä¼š**é€€åŒ–æˆè¡Œé”**ï¼ˆå› ä¸ºä¸éœ€è¦é”é—´éš™æ¥é˜²æ­¢å¹»è¯»ï¼Œå·²ç»èƒ½å”¯ä¸€ç¡®å®šä¸€è¡Œäº†ï¼‰ã€‚
-   å¯¹äºŽ**æ™®é€šç´¢å¼•**æˆ–**èŒƒå›´æŸ¥è¯¢**ï¼Œä¸´é”®é”æ˜¯é˜²æ­¢å¹»è¯»çš„å…³é”®ã€‚

### å¦‚ä½•æŸ¥çœ‹å’ŒæŽ’æŸ¥é”ï¼Ÿ

å¦‚æžœä½ é‡åˆ°é”ç­‰å¾…æˆ–æ­»é”ï¼Œå¯ä»¥ä½¿ç”¨è¿™äº›å‘½ä»¤ï¼š
```sql
-- æŸ¥çœ‹å½“å‰æ­£åœ¨å‘ç”Ÿçš„é”ç­‰å¾…
SHOW ENGINE INNODB STATUS;

-- æŸ¥çœ‹ä¿¡æ¯_schemaåº“ä¸­çš„é”ä¿¡æ¯ï¼ˆMySQL 5.7+ï¼‰
SELECT * FROM performance_schema.data_locks;
SELECT * FROM performance_schema.data_lock_waits;
```

ç†è§£è¿™äº›é”æœºåˆ¶ï¼Œèƒ½å¸®åŠ©ä½ æ›´å¥½åœ°è®¾è®¡æ•°æ®åº“ç´¢å¼•ã€ç¼–å†™SQLè¯­å¥ï¼Œä»¥åŠåˆ†æžå’Œè§£å†³ç”Ÿäº§ä¸­å¤æ‚çš„å¹¶å‘é—®é¢˜ã€‚



ä½ è¿™ä¸¤ä¸ªé—®é¢˜é—®å¾—éžå¸¸éžå¸¸å¥½ï¼Œç›´å‡»äº† InnoDB å¹¶å‘æŽ§åˆ¶æœºåˆ¶çš„ä¸¤ä¸ªæ ¸å¿ƒä¸”å®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼š**é” (Locking)** å’Œ **å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ (MVCC - Multiversion Concurrency Control)**ã€‚

å®ƒä»¬çš„èŒè´£ä¸åŒï¼ŒååŒå·¥ä½œæ¥è§£å†³ä¸åŒçš„é—®é¢˜ã€‚æˆ‘ä»¬æ¥å½»åº•è®²æ¸…æ¥šã€‚

---

### é—®é¢˜ä¸€ï¼šåŠ é”åªåŠ åœ¨ç´¢å¼•é¡¹ï¼Œä¸æ˜¯æœ‰å¯èƒ½å…¶ä»–äº‹åŠ¡ä¿®æ”¹æ•°æ®è¡Œçš„å…¶ä»–åˆ—å—ï¼Ÿ

**ä½ çš„æ‹…å¿ƒæ˜¯å¯¹çš„ï¼Œä½†é”æœºåˆ¶èƒ½é˜²æ­¢è¿™ç§æƒ…å†µã€‚å…³é”®åœ¨äºŽç†è§£é”çš„â€œå¯¹è±¡â€å’Œâ€œä½œç”¨â€ã€‚**

1.  **é”åŠ åœ¨ç´¢å¼•ä¸Šï¼Œä½†ä¿æŠ¤çš„æ˜¯æ•°æ®**ï¼š
    -   è™½ç„¶é”æ˜¯åŠ åœ¨**ç´¢å¼•é¡¹**ä¸Šçš„ï¼Œä½†è¿™ä¸ªç´¢å¼•é¡¹ï¼ˆå°¤å…¶æ˜¯ä¸»é”®ç´¢å¼•ï¼‰**ç›´æŽ¥æŒ‡å‘æœ€ç»ˆçš„æ•°æ®è¡Œ**ã€‚
    -   å½“ä¸€ä¸ªäº‹åŠ¡æŒæœ‰äº†æŸæ¡è®°å½•çš„ **Xé”ï¼ˆæŽ’ä»–é”ï¼‰** æ—¶ï¼Œå…¶ä»–ä»»ä½•äº‹åŠ¡éƒ½æ— æ³•å†èŽ·å¾—è¿™æ¡è®°å½•çš„ Xé” æˆ– Sé”ï¼ˆå…±äº«é”ï¼‰ã€‚
    -   **â€œä¿®æ”¹æ•°æ®è¡Œçš„å…¶ä»–åˆ—â€è¿™ä¸ªæ“ä½œæœ¬èº«ï¼Œå°±éœ€è¦å…ˆèŽ·å–è¯¥è¡Œçš„ Xé”**ã€‚æ—¢ç„¶ç¬¬ä¸€ä¸ªäº‹åŠ¡å·²ç»æŒæœ‰äº†Xé”ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªäº‹åŠ¡åœ¨å°è¯•ä¿®æ”¹ï¼ˆä¹Ÿéœ€è¦èŽ·å–Xé”ï¼‰æ—¶å°±ä¼šè¢«é˜»å¡žï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾é”ã€‚

**ä¸¾ä¸ªä¾‹å­ï¼š**
-   **äº‹åŠ¡A** æ‰§è¡Œï¼š`UPDATE users SET balance = balance - 100 WHERE id = 1;`
    -   InnoDB åœ¨ `id=1` è¿™ä¸ªä¸»é”®ç´¢å¼•é¡¹ä¸Šè®¾ç½®äº† Xé”ã€‚
-   **äº‹åŠ¡B** è¯•å›¾æ‰§è¡Œï¼š`UPDATE users SET name = 'Bob' WHERE id = 1;` ï¼ˆè¯•å›¾ä¿®æ”¹å¦ä¸€åˆ—ï¼‰
    -   äº‹åŠ¡Bä¹Ÿéœ€è¦åœ¨ `id=1` è¿™ä¸ªç´¢å¼•é¡¹ä¸ŠèŽ·å¾— Xé”ã€‚
    -   ä½†å®ƒå‘çŽ°äº‹åŠ¡Aå·²ç»æŒæœ‰äº†Xé”ï¼Œå› æ­¤**äº‹åŠ¡Bä¼šè¢«æŒ‚èµ·ï¼Œè¿›å…¥é”ç­‰å¾…çŠ¶æ€**ã€‚
    -   ç›´åˆ°äº‹åŠ¡Aæäº¤æˆ–å›žæ»šï¼Œé‡Šæ”¾äº†Xé”ï¼Œäº‹åŠ¡Bæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚

**ç»“è®º**ï¼šé”åŠ åœ¨ç´¢å¼•ä¸Šï¼Œä½†é€šè¿‡æŽ§åˆ¶ç´¢å¼•é¡¹çš„è®¿é—®ï¼Œæœ‰æ•ˆåœ°**ä¿æŠ¤äº†æ•´è¡Œæ•°æ®**ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡ä»¥ä»»ä½•æ–¹å¼ï¼ˆä¿®æ”¹ä»»ä½•åˆ—ï¼‰è®¿é—®è¢«é”å®šçš„è¡Œï¼ˆé™¤éžæ˜¯å¿«ç…§è¯»ï¼‰ã€‚

---

### é—®é¢˜äºŒï¼šSELECTè¯»å‰¯æœ¬ï¼Œä¿®æ”¹æ“ä½œæ”¹å˜æœ€æ–°ç‰ˆæœ¬ï¼Œæ‰€ä»¥åŠ é”ä¸å½±å“SELECTï¼Ÿ

**å®Œå…¨æ­£ç¡®ï¼è¿™æ­£æ˜¯ MVCC æœºåˆ¶çš„ç²¾é«“æ‰€åœ¨ï¼Œå®ƒå®Œç¾Žåœ°è§£å†³äº†â€œè¯»å†™å†²çªâ€çš„é—®é¢˜ã€‚**

InnoDB é€šè¿‡ **MVCC** å’Œ **é”** è¿™ä¸¤å¥—æœºåˆ¶æ¥åº”å¯¹ä¸åŒçš„å¹¶å‘åœºæ™¯ï¼š

| æœºåˆ¶ | è§£å†³ä»€ä¹ˆå†²çªï¼Ÿ | å¦‚ä½•å·¥ä½œï¼Ÿ | æ•ˆæžœ |
| :--- | :--- | :--- | :--- |
| **MVCC** | **è¯»å†™å†²çª** (Read-Write) | ä¸ºæ¯ä¸ªæ•°æ®è¡Œç»´æŠ¤å¤šä¸ªåŽ†å²ç‰ˆæœ¬ã€‚`SELECT` æŸ¥è¯¢ä¼šåŸºäºŽæŸä¸ªæ—¶é—´ç‚¹ï¼ˆäº‹åŠ¡å¼€å§‹æ—¶çš„ç³»ç»Ÿç‰ˆæœ¬å·ï¼‰åˆ›å»ºä¸€ä¸ª**ä¸€è‡´æ€§è¯»è§†å›¾**ï¼Œåªè¯»å–åœ¨è¯¥æ—¶é—´ç‚¹ä¹‹å‰å·²ç»æäº¤çš„æ•°æ®å¿«ç…§ã€‚ | **è¯»ä¸é˜»å¡žå†™ï¼Œå†™ä¸é˜»å¡žè¯»**ã€‚è¯»å†™æ“ä½œå¯ä»¥å¹¶å‘è¿›è¡Œï¼Œæžå¤§æå‡äº†æ€§èƒ½ã€‚ |
| **é”** | **å†™å†™å†²çª** (Write-Write) | å½“æ•°æ®è¦è¢«ä¿®æ”¹æ—¶ï¼Œä½¿ç”¨é”ï¼ˆä¸»è¦æ˜¯Xé”ï¼‰æ¥ç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªäº‹åŠ¡èƒ½ä¿®æ”¹æŸæ¡æ•°æ®ã€‚ | **å†™æ“ä½œä¼šç›¸äº’é˜»å¡ž**ã€‚ä¿è¯äº†æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œé˜²æ­¢æ›´æ–°ä¸¢å¤±ã€‚ |

**æŠŠå®ƒä»¬æ”¾åœ¨ä¸€ä¸ªåœºæ™¯é‡Œå°±éžå¸¸æ¸…æ™°äº†ï¼š**

å‡è®¾ `users` è¡¨ä¸­æœ‰ä¸€æ¡è®°å½•ï¼š`id = 1, name = 'Alice', balance = 1000`ã€‚

1.  **æ—¶åˆ» T1**ï¼š
    -   **äº‹åŠ¡A** (éš”ç¦»çº§åˆ« `REPEATABLE READ`) å¼€å§‹ï¼š`BEGIN;`
    -   **äº‹åŠ¡A** æ‰§è¡Œï¼š`SELECT balance FROM users WHERE id = 1;` // è¯»åˆ° 1000
    -   æ­¤æ—¶ï¼Œäº‹åŠ¡AåŸºäºŽT1æ—¶åˆ»åˆ›å»ºäº†ä¸€ä¸ª**è¯»è§†å›¾**ã€‚

2.  **æ—¶åˆ» T2**ï¼š
    -   **äº‹åŠ¡B** å¼€å§‹å¹¶æ‰§è¡Œï¼š`UPDATE users SET balance = 900 WHERE id = 1;` // æˆåŠŸèŽ·å–Xé”ï¼Œä¿®æ”¹æ•°æ®ã€‚
    -   æ­¤æ—¶ï¼ŒInnoDB å¹¶ä¸æ˜¯ç›´æŽ¥è¦†ç›–åŽŸæ•°æ®ï¼Œè€Œæ˜¯ï¼š
        -   å°† `balance = 1000` çš„æ—§ç‰ˆæœ¬æ•°æ®å­˜å…¥ **undo log**ã€‚
        -   å°†å½“å‰è¡Œçš„æ•°æ®æ›´æ–°ä¸º `balance = 900`ï¼Œå¹¶æ›´æ–°ä¸€ä¸ªç‰ˆæœ¬å·ã€‚

3.  **æ—¶åˆ» T3**ï¼š
    -   **äº‹åŠ¡A** å†æ¬¡æ‰§è¡Œï¼š`SELECT balance FROM users WHERE id = 1;`
    -   å®ƒ**ä¸ä¼šåŽ»è¯»æœ€æ–°çš„æ•°æ®**ï¼ˆ900ï¼‰ï¼Œè€Œæ˜¯ä¼šåŽ» **undo log** ä¸­å¯»æ‰¾ç¬¦åˆå®ƒè¯»è§†å›¾æ—¶é—´ç‚¹çš„åŽ†å²ç‰ˆæœ¬æ•°æ®ï¼Œæ‰€ä»¥å®ƒè¯»åˆ°çš„ä¾ç„¶æ˜¯ **1000**ã€‚ï¼ˆè¿™å°±æ˜¯â€œå¯é‡å¤è¯»â€ï¼‰
    -   **ä¸Žæ­¤åŒæ—¶ï¼Œäº‹åŠ¡Bçš„å†™æ“ä½œå®Œå…¨ä¸å—äº‹åŠ¡Aè¯»æ“ä½œçš„å½±å“ï¼Œå®ƒæ—©å·²å®Œæˆã€‚**

4.  **æ—¶åˆ» T4**ï¼š
    -   **äº‹åŠ¡B** æäº¤ï¼š`COMMIT;`
    -   **äº‹åŠ¡C** å¼€å§‹å¹¶æ‰§è¡Œï¼š`SELECT ... FROM users WHERE id = 1;` // å› ä¸ºäº‹åŠ¡Cæ˜¯åœ¨äº‹åŠ¡Bæäº¤åŽå¼€å§‹çš„ï¼Œå®ƒçš„è¯»è§†å›¾ä¼šåŒ…å«äº‹åŠ¡Bçš„æäº¤ï¼Œæ‰€ä»¥å®ƒä¼šè¯»åˆ°æœ€æ–°çš„å€¼ **900**ã€‚

5.  **æ—¶åˆ» T5**ï¼š
    -   å¦‚æžœæ­¤æ—¶æœ‰**äº‹åŠ¡D** å°è¯•æ‰§è¡Œ `UPDATE users SET balance = 800 WHERE id = 1;`ï¼Œå®ƒä¼š**è¢«é˜»å¡ž**ï¼Œå› ä¸º**äº‹åŠ¡Aä»ç„¶æŒæœ‰id=1çš„è¡Œé”å—ï¼Ÿä¸ï¼Œäº‹åŠ¡Aæ˜¯è¯»æ“ä½œï¼Œé»˜è®¤ä¸åŠ é”ã€‚**
    -   è¿™é‡Œéœ€è¦ä¿®æ­£ï¼š**æ™®é€šSELECTä¸åŠ é”ï¼Œæ‰€ä»¥ä¸ä¼šé˜»å¡žäº‹åŠ¡D**ã€‚äº‹åŠ¡Dä¼šæˆåŠŸèŽ·å–Xé”å¹¶æ‰§è¡Œæ›´æ–°ã€‚

**æ•´ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒè¦ç‚¹ï¼š**

-   **SELECT (å¿«ç…§è¯»)**ï¼šè®¿é—®çš„æ˜¯**åŽ†å²ç‰ˆæœ¬**ï¼Œåƒä¸€ä¸ªæ—è§‚è€…ï¼Œä¸æ‰“æ‰°ä»»ä½•äººï¼Œä¹Ÿä¸éœ€è¦è¢«ä»»ä½•äººæ‰“æ‰°ã€‚å®ƒä¸å—é”çš„å½±å“ã€‚
-   **UPDATE/DELETE (å½“å‰è¯»)**ï¼šè®¿é—®çš„æ˜¯**æœ€æ–°ç‰ˆæœ¬**ï¼Œå¹¶ä¸”å¿…é¡»ç»™æ•°æ®åŠ é”ï¼Œåƒä¸€ä¸ªä¿®æ”¹è€…ï¼Œéœ€è¦ç‹¬å æƒé™ï¼Œä¼šé˜»æ­¢å…¶ä»–ä¿®æ”¹è€…ã€‚
-   **é”**ï¼šæ˜¯**å†™å†™æ“ä½œ**ä¹‹é—´çš„â€œäº¤é€šä¿¡å·ç¯â€ï¼Œé˜²æ­¢ä¸¤ä¸ªä¿®æ”¹è€…åŒæ—¶æ“ä½œä¸€æ¡æ•°æ®ï¼Œé€ æˆæ··ä¹±ã€‚
-   **MVCC**ï¼šæ˜¯**è¯»å†™æ“ä½œ**ä¹‹é—´çš„â€œå¹³è¡Œå®‡å®™â€ï¼Œè®©è¯»è€…å’Œå†™è€…å„è‡ªåœ¨ä¸åŒçš„æ—¶é—´çº¿ä¸Šå·¥ä½œï¼Œäº’ä¸é˜»å¡žã€‚

æ‰€ä»¥ï¼Œä½ çš„ç†è§£æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼š**åŠ é”æ˜¯ä¸ºäº†é˜²æ­¢â€œå†™å†™å†²çªâ€ï¼Œè€ŒMVCCé€šè¿‡ç»´æŠ¤å¤šç‰ˆæœ¬è§£å†³äº†â€œè¯»å†™å†²çªâ€ã€‚** æ­£æ˜¯è¿™ä¸¤å¥—æœºåˆ¶çš„é«˜æ•ˆååŒï¼Œæ‰ä½¿å¾— InnoDB èƒ½åœ¨ä¿è¯äº‹åŠ¡éš”ç¦»æ€§çš„åŒæ—¶ï¼Œæä¾›æžé«˜çš„å¹¶å‘æ€§èƒ½ã€‚


### åŠ é”è¿‡ç¨‹


#### åœºæ™¯

è¡¨ `t` æœ‰ä¸€ä¸ªä¸»é”®ç´¢å¼• `id`ï¼Œå·²æœ‰æ•°æ®å¦‚ä¸‹ï¼š

```
id = 1, 2, 5, 9, 10
```

---

####  æŸ¥è¯¢ä¸€è¡Œ + åŠ é”

```sql
SELECT * FROM t WHERE id = 9 FOR UPDATE;
```

ðŸ”’ åŠ é”èŒƒå›´ï¼š

```
(-âˆž , 1)   â†’ é—´éš™é”
[1]        â†’ è¡Œé”
(1 , 2)    â†’ é—´éš™é”
[2]        â†’ è¡Œé”
(2 , 5)    â†’ é—´éš™é”
[5]        â†’ è¡Œé”
(5 , 9)    â†’ é—´éš™é”
[9]        â†’ è¡Œé”ï¼ˆä½ è¦çš„è¡Œï¼‰
(9 , 10)   â†’ é—´éš™é”
[10]       â†’ è¡Œé”
(10 , +âˆž)  â†’ é—´éš™é”
```

ðŸ‘‰ å…³é”®ç‚¹ï¼š

- `id=9` è¢« **è¡Œé”** é”ä½ã€‚
    
- `id=9` å‰åŽçš„ç©ºéš™ `(5,9)`ã€`(9,10)` è¢« **é—´éš™é”** é”ä½ã€‚
    
- é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ **id=8ã€id=9.5** ä¹‹ç±»çš„æ•°æ®ï¼Œé¿å…å¹»è¯»ã€‚
    

---

#### æŸ¥è¯¢èŒƒå›´ + åŠ é”

```sql
SELECT * FROM t WHERE id BETWEEN 2 AND 9 FOR UPDATE;
```

ðŸ”’ åŠ é”èŒƒå›´ï¼š

```
(1 , 2)    â†’ é—´éš™é”
[2]        â†’ è¡Œé”
(2 , 5)    â†’ é—´éš™é”
[5]        â†’ è¡Œé”
(5 , 9)    â†’ é—´éš™é”
[9]        â†’ è¡Œé”
(9 , 10)   â†’ é—´éš™é”
```

ðŸ‘‰ å…³é”®ç‚¹ï¼š

- `id=2, 5, 9` è¢«è¡Œé”é”ä½ã€‚
    
- ä¸­é—´çš„ç©ºéš™ä¹Ÿè¢«é”ä½ â†’ é˜²æ­¢åˆ«äººæ’å…¥ 3ã€4ã€6ã€7ã€8 è¿™äº›æ–°è¡Œã€‚
    

---

####  æ²¡æœ‰ç´¢å¼•ï¼Œå…¨è¡¨æ‰«æ

```sql
SELECT * FROM t WHERE id = 9 FOR UPDATE;
```

ä½† **id æ²¡æœ‰ç´¢å¼•**ï¼Œåªèƒ½å…¨è¡¨æ‰«æã€‚

ðŸ”’ åŠ é”æ–¹å¼ï¼š

- ä»Žç¬¬ä¸€è¡Œå¼€å§‹ï¼Œé€è¡Œåˆ¤æ–­ + åŠ é”ã€‚
    
- ç›´åˆ°æ‰«å®Œæ•´ä¸ªè¡¨ï¼Œæ‰€æœ‰è¡Œéƒ½è¢«é”ä½ã€‚
    
- æ•ˆæžœ â‰ˆ è¡¨é”ã€‚
    

---

âœ… **æ€»ç»“å›¾è§£**

- **è¡Œé”**ï¼šé”ä½å®žé™…å­˜åœ¨çš„è¡Œï¼ˆç”¨ `[ ]` è¡¨ç¤ºï¼‰ã€‚
    
- **é—´éš™é”**ï¼šé”ä½ä¸¤è¡Œä¹‹é—´çš„èŒƒå›´ï¼ˆç”¨ `( )` è¡¨ç¤ºï¼‰ã€‚
    
- **æ²¡æœ‰ç´¢å¼•**ï¼šå…¨è¡¨è¡Œé”ï¼Œé—´éš™é”å¤±æ•ˆï¼ˆå› ä¸ºæ— æ³•ç¡®å®šèŒƒå›´ï¼‰ã€‚
    



### æ•°æ®å­˜å‚¨

#### 1. MySQL æ•°æ®å­˜å‚¨åœ¨å“ªï¼Ÿ

- MySQL å¸¸ç”¨å­˜å‚¨å¼•æ“Žæ˜¯ **InnoDB**ï¼ˆé»˜è®¤ï¼‰ã€‚
    
- æ¯å¼ è¡¨å¯¹åº” **ä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶**ï¼ˆæ—©æœŸ `.ibd` æ–‡ä»¶ï¼ŒçŽ°åœ¨ä¹Ÿå¯èƒ½å­˜åœ¨åœ¨å…±äº«è¡¨ç©ºé—´ `ibdata1` é‡Œï¼‰ã€‚
    
- è¡¨ç©ºé—´æ–‡ä»¶é‡Œå­˜å‚¨ï¼š
    
    - **æ•°æ®é¡µ (Data Page)**
        
    - **ç´¢å¼•é¡µ (Index Page)**
        
    - **Undo/Redo æ—¥å¿—ç‰‡æ®µ**
        
    - **å…¶ä»–ç³»ç»Ÿä¿¡æ¯**
        

ðŸ‘‰ æ‰€ä»¥ç‰©ç†ä¸Šï¼Œæ•°æ®å°±åœ¨ **ç£ç›˜æ–‡ä»¶**é‡Œï¼ˆè¡¨ç©ºé—´ï¼‰ã€‚

---

#### 2. å­˜å‚¨çš„åŸºæœ¬å•ä½ï¼šé¡µ (Page)

InnoDB é»˜è®¤é¡µå¤§å°æ˜¯ **16KB**ã€‚  
é¡µæ˜¯æœ€å°çš„å­˜å‚¨å’Œè¯»å†™å•ä½ã€‚

å¸¸è§çš„é¡µç±»åž‹ï¼š

- **æ•°æ®é¡µ (Leaf Page)**ï¼šå­˜è¡¨çš„å®žé™…è¡Œæ•°æ®ã€‚
    
- **ç´¢å¼•é¡µ (Non-leaf Page)**ï¼šå­˜ç´¢å¼•é”® + æŒ‡é’ˆï¼ˆæŒ‡å‘ä¸‹ä¸€å±‚é¡µï¼‰ã€‚
    
- **Undo Page**ï¼šå­˜å›žæ»šä¿¡æ¯ã€‚
    
- **å…¶ä»–å…ƒæ•°æ®é¡µ**ã€‚
    

ðŸ‘‰ æ‰€ä»¥æ¯æ¬¡æŸ¥è¯¢ï¼ŒMySQL æœ€å°ä¼šåŠ è½½ä¸€é¡µï¼ˆ16KBï¼‰åˆ°å†…å­˜é‡Œï¼ˆBuffer Poolï¼‰ã€‚

---

#### 3. è¡Œæ•°æ®çš„å­˜å‚¨

åœ¨æ•°æ®é¡µé‡Œï¼Œæ¯ä¸€è¡Œçš„å­˜å‚¨å¤§è‡´åŒ…å«ï¼š

- **éšè—åˆ—**ï¼ˆäº‹åŠ¡ IDï¼Œå›žæ»šæŒ‡é’ˆï¼Œè¡Œ IDï¼‰ã€‚
    
- **ç”¨æˆ·å®šä¹‰åˆ—**ï¼ˆä½ çš„è¡¨å­—æ®µï¼Œæ¯”å¦‚ `id, name, age`ï¼‰ã€‚
    
- **NULL æ ‡å¿—ä½**ï¼ˆå­—æ®µæ˜¯å¦ä¸º NULLï¼‰ã€‚
    
- **å˜é•¿å­—æ®µé•¿åº¦è¡¨**ï¼ˆVARCHAR ç­‰å­—æ®µçš„é•¿åº¦ï¼‰ã€‚
    

ðŸ‘‰ æ‰€ä»¥ MySQL å®žé™…ä¸Šä¸€è¡Œæ•°æ®æ¯”ä½ å®šä¹‰çš„å­—æ®µè¦å¤šï¼ŒInnoDB ä¼šè‡ªåŠ¨åŠ ä¸Šäº‹åŠ¡æŽ§åˆ¶éœ€è¦çš„éšè—ä¿¡æ¯ã€‚

---

#### 4. ä¸»é”®ç´¢å¼• (Clustered Index)

è¿™æ˜¯ InnoDB çš„æ ¸å¿ƒï¼š

- InnoDB **å¿…é¡»æœ‰ä¸€ä¸ªä¸»é”®**ï¼Œå¦‚æžœä½ æ²¡å®šä¹‰ï¼Œå®ƒä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªã€‚
    
- **æ•°æ®æŒ‰ç…§ä¸»é”®é¡ºåºï¼Œå­˜æ”¾åœ¨ B+Tree çš„å¶å­èŠ‚ç‚¹é‡Œ**ã€‚
    
    - å¶å­èŠ‚ç‚¹ = **æ•´è¡Œæ•°æ®**ã€‚
        
    - éžå¶å­èŠ‚ç‚¹ = **ç´¢å¼•é”® + æŒ‡é’ˆ**ã€‚
        
- å› ä¸ºä¸»é”®ç´¢å¼•å­˜äº†â€œæ•°æ®æœ¬èº«â€ï¼Œå®ƒåˆå« **èšç°‡ç´¢å¼• (Clustered Index)**ã€‚
    

ðŸ‘‰ æ‰€ä»¥ä½ å¯ä»¥ç†è§£ä¸ºï¼š  
è¡¨çš„æ•°æ®æœ¬èº«å°±æ˜¯ä¸€æ£µ **ä¸»é”® B+Tree**ã€‚

---

#### 5. äºŒçº§ç´¢å¼• (Secondary Index)

å¦‚æžœä½ åœ¨ `name` ä¸Šå»ºäº†ç´¢å¼•ï¼š

- InnoDB ä¼šå†å»ºä¸€æ£µ B+Treeã€‚
    
- **å¶å­èŠ‚ç‚¹ä¸æ˜¯æ•´è¡Œæ•°æ®ï¼Œè€Œæ˜¯ä¸»é”®å€¼**ã€‚
    
- æŸ¥è¯¢æ—¶ï¼š
    
    1. å…ˆèµ° `name` ç´¢å¼• â†’ æ‰¾åˆ°ä¸»é”® IDã€‚
        
    2. å†ç”¨ä¸»é”®åŽ»ä¸»é”®ç´¢å¼•æ ‘é‡Œæ‰¾æ•°æ®ã€‚
        
- è¿™ä¸ªè¿‡ç¨‹å« **å›žè¡¨ (Back to Clustered Index)**ã€‚
    

ðŸ‘‰ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ **InnoDB çš„äºŒçº§ç´¢å¼•å¿…é¡»ä¾èµ–ä¸»é”®ç´¢å¼•**ã€‚

---

#### 6. æŸ¥è¯¢è¿‡ç¨‹ç¤ºä¾‹

å‡è®¾è¡¨ï¼š

```sql
CREATE TABLE user (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  age INT
);
```

æ•°æ®ï¼š

|id|name|age|
|---|---|---|
|1|A|20|
|2|B|21|
|3|C|22|

---

 ä¾‹ 1ï¼š`SELECT * FROM user WHERE id = 2;`

- ç›´æŽ¥èµ° **ä¸»é”® B+Tree**ã€‚
    
- ä»Žæ ¹èŠ‚ç‚¹æŸ¥åˆ°å¶å­èŠ‚ç‚¹ â†’ ç›´æŽ¥æ‹¿åˆ°æ•´è¡Œ `(2, B, 21)`ã€‚
    
- **O(logN)** æŸ¥æ‰¾æ•ˆçŽ‡ã€‚
    

---

 ä¾‹ 2ï¼š`SELECT * FROM user WHERE name = 'B';`

- èµ° **name äºŒçº§ç´¢å¼• B+Tree**ã€‚
    
- æ‰¾åˆ° `name='B'` â†’ å¾—åˆ°ä¸»é”® `id=2`ã€‚
    
- å†å›žè¡¨åˆ° **ä¸»é”® B+Tree**ï¼Œæ‹¿åˆ° `(2, B, 21)`ã€‚
    
- è¿™æ¯”å…¨è¡¨æ‰«æå¿«å¾ˆå¤šã€‚
    

---

 ä¾‹ 3ï¼š`SELECT * FROM user WHERE age=21;`

- å¦‚æžœ `age` æ²¡æœ‰ç´¢å¼• â†’ å¿…é¡» **å…¨è¡¨æ‰«æ**ã€‚
    
- æ‰«ææ¯ä¸ªé¡µï¼Œæ¯è¡Œæ¯”å¯¹ `age` å­—æ®µã€‚
    
- é€Ÿåº¦å°±ä¼šæ…¢ã€‚
    

---

#### 7. æ€»ç»“

- **æ•°æ®å®žé™…å­˜å‚¨**ï¼šè¡¨ç©ºé—´æ–‡ä»¶é‡Œï¼ŒæŒ‰é¡µå­˜å‚¨ï¼Œä¸»é”®ç´¢å¼• B+Tree çš„å¶å­èŠ‚ç‚¹å°±æ˜¯æ•´è¡Œæ•°æ®ã€‚
    
- **æŸ¥è¯¢åŽŸç†**ï¼šèµ°ä¸»é”®ç´¢å¼•æ—¶ç›´è¾¾æ•°æ®ï¼›èµ°äºŒçº§ç´¢å¼•æ—¶è¦å›žè¡¨ï¼›æ²¡ç´¢å¼•æ—¶åªèƒ½å…¨è¡¨æ‰«æã€‚
    
- **é«˜æ•ˆçš„å…³é”®**ï¼šç´¢å¼•ï¼ˆå°¤å…¶æ˜¯ä¸»é”®ç´¢å¼•ï¼‰å†³å®šäº†æ•°æ®ç»„ç»‡ç»“æž„å’Œè®¿é—®è·¯å¾„ã€‚
    

---

è¦ä¸è¦æˆ‘å¸®ä½ ç”»ä¸€å¼  **å›¾è§£ï¼šä¸»é”®ç´¢å¼•æ ‘ + äºŒçº§ç´¢å¼•æ ‘ â†’ æŸ¥è¯¢è·¯å¾„**ï¼Œè¿™æ ·ä½ èƒ½ä¸€çœ¼çœ‹åˆ° MySQL æ•°æ®æ˜¯æ€Žä¹ˆâ€œé•¿åœ¨æ ‘é‡Œâ€çš„ï¼Ÿ